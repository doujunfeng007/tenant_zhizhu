<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.minigod.zero.log.mapper.LogApiMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="logResultMap" type="com.minigod.zero.core.log.model.LogApi">
        <result column="id" property="id"/>
        <result column="create_time" property="createTime"/>
        <result column="service_id" property="serviceId"/>
        <result column="server_host" property="serverHost"/>
        <result column="server_ip" property="serverIp"/>
        <result column="env" property="env"/>
        <result column="type" property="type"/>
        <result column="title" property="title"/>
        <result column="method" property="method"/>
        <result column="request_uri" property="requestUri"/>
        <result column="user_agent" property="userAgent"/>
        <result column="remote_ip" property="remoteIp"/>
        <result column="method_class" property="methodClass"/>
        <result column="method_name" property="methodName"/>
        <result column="params" property="params"/>
        <result column="time" property="time"/>
        <result column="create_by" property="createBy"/>
    </resultMap>
    <select id="selectLogPage" resultMap="logResultMap">
        SELECT `id`,
        `tenant_id`,
        `service_id`,
        `server_host`,
        `server_ip`,
        `env`,
        `type`,
        `title`,
        `method`,
        `request_uri`,
        `user_agent`,
        `remote_ip`,
        `method_class`,
        `method_name`,
        `time`,
        `create_by`,
        `create_time`
        FROM zero_log_api
        <where>
            <if test="log.type != null and log.type!=''">
                and type = #{log.type}
            </if>
            <if test="log.serviceId != null and log.serviceId!=''">
                and service_id = #{log.serviceId}
            </if>
            <if test="log.method != null and log.method!=''">
                and method = #{log.method}
            </if>
            <if test="log.methodClass != null and log.methodClass!=''">
                and method_class = #{log.methodClass}
            </if>
            <if test="log.methodName != null and log.methodName!=''">
                and method_name = #{log.methodName}
            </if>
            <if test="log.requestUri != null and log.requestUri!=''">
                and request_uri like concat(concat('%', #{log.requestUri}),'%')
            </if>
            <if test="log.remoteIp != null and log.remoteIp!=''">
                and remote_ip = #{log.remoteIp}
            </if>
            <if test="log.userAgent != null and log.userAgent!=''">
                and user_agent = #{log.userAgent}
            </if>
            <if test="log.time != null and log.time!=''">
                and `time` = #{log.time}
            </if>
            <if test="log.title != null and log.title!=''">
                and title like concat(concat('%', #{log.title}),'%')
            </if>
            <if test="log.startTime != null and log.startTime!=''">
                and create_time <![CDATA[ >= ]]> #{log.startTime}
            </if>
            <if test="log.endTime != null and log.endTime !=''">
                and create_time <![CDATA[ <= ]]> #{log.endTime}
            </if>
        </where>
        ORDER BY `create_time` DESC
    </select>

    <select id="selectLogList" resultMap="logResultMap">
        SELECT `id`,
        `tenant_id`,
        `service_id`,
        `server_host`,
        `server_ip`,
        `env`,
        `type`,
        `title`,
        `method`,
        `request_uri`,
        `user_agent`,
        `remote_ip`,
        `method_class`,
        `method_name`,
        `params`, -- 该字段内容可能会超出单元格字符最大长度 The maximum length of cell contents (text) is 32,767 characters
        `time`,
        `create_by`,
        `create_time`
        FROM zero_log_api
        <where>
            <if test="log.type != null and log.type!=''">
                and type = #{log.type}
            </if>
            <if test="log.serviceId != null and log.serviceId!=''">
                and service_id = #{log.serviceId}
            </if>
            <if test="log.method != null and log.method!=''">
                and method = #{log.method}
            </if>
            <if test="log.methodClass != null and log.methodClass!=''">
                and method_class = #{log.methodClass}
            </if>
            <if test="log.methodName != null and log.methodName!=''">
                and method_name = #{log.methodName}
            </if>
            <if test="log.requestUri != null and log.requestUri!=''">
                and request_uri like concat(concat('%', #{log.requestUri}),'%')
            </if>
            <if test="log.remoteIp != null and log.remoteIp!=''">
                and remote_ip = #{log.remoteIp}
            </if>
            <if test="log.userAgent != null and log.userAgent!=''">
                and user_agent = #{log.userAgent}
            </if>
            <if test="log.time != null and log.time!=''">
                and `time` = #{log.time}
            </if>
            <if test="log.title != null and log.title!=''">
                and title like concat(concat('%', #{log.title}),'%')
            </if>
            <if test="log.startTime != null and log.startTime!=''">
                and create_time <![CDATA[ >= ]]> #{log.startTime}
            </if>
            <if test="log.endTime != null and log.endTime !=''">
                and create_time <![CDATA[ <= ]]> #{log.endTime}
            </if>
        </where>
        -- 排序会导致大字段报内存溢出问题，所以先注释掉
        -- ORDER BY `create_time` DESC
    </select>

    <select id="selectLogCount" resultType="java.lang.Long">
        select count(0)
        FROM zero_log_api
        <where>
            <if test="log.type != null and log.type!=''">
                and type = #{log.type}
            </if>
            <if test="log.serviceId != null and log.serviceId!=''">
                and service_id = #{log.serviceId}
            </if>
            <if test="log.method != null and log.method!=''">
                and method = #{log.method}
            </if>
            <if test="log.methodClass != null and log.methodClass!=''">
                and method_class = #{log.methodClass}
            </if>
            <if test="log.methodName != null and log.methodName!=''">
                and method_name = #{log.methodName}
            </if>
            <if test="log.requestUri != null and log.requestUri!=''">
                and request_uri like concat(concat('%', #{log.requestUri}),'%')
            </if>
            <if test="log.remoteIp != null and log.remoteIp!=''">
                and remote_ip = #{log.remoteIp}
            </if>
            <if test="log.userAgent != null and log.userAgent!=''">
                and user_agent = #{log.userAgent}
            </if>
            <if test="log.time != null and log.time!=''">
                and `time` = #{log.time}
            </if>
            <if test="log.title != null and log.title!=''">
                and title like concat(concat('%', #{log.title}),'%')
            </if>
            <if test="log.startTime != null and log.startTime!=''">
                and create_time <![CDATA[ >= ]]> #{log.startTime}
            </if>
            <if test="log.endTime != null and log.endTime !=''">
                and create_time <![CDATA[ <= ]]> #{log.endTime}
            </if>
        </where>
        ORDER BY `create_time` DESC
    </select>

</mapper>
