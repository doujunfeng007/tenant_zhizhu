<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.minigod.zero.manage.mapper.OperateActRewardPlanMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.minigod.zero.manage.entity.OperateActRewardPlanEntity">
        <id column="id" property="id"/>
        <result column="fun_type" property="funType"/>
        <result column="plan_id" property="planId"/>
        <result column="start_amount" property="startAmount"/>
        <result column="end_amount" property="endAmount"/>
        <result column="cash_amount" property="cashAmount"/>
        <result column="free_days" property="freeDays"/>
        <result column="reward_condition" property="rewardCondition"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_user" property="createUser"/>
        <result column="update_user" property="updateUser"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="create_dept" property="createDept"/>
        <result column="status" property="status"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, fun_type, plan_id, start_amount, end_amount, cash_amount, free_days,
        reward_condition, create_time, update_time, create_user, update_user,
        is_deleted, tenant_id, create_dept, status
    </sql>

    <!-- 分页查询 -->
    <select id="queryPage" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM operate_act_reward_plan
        WHERE is_deleted = 0
        <if test="planId != null">
            AND plan_id = #{planId}
        </if>
        <if test="funType != null">
            AND fun_type = #{funType}
        </if>
        ORDER BY start_amount ASC
    </select>

    <!-- 查询方案下的奖励配置 -->
    <select id="queryByPlanId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM operate_act_reward_plan
        WHERE is_deleted = 0
        AND status = 0
        AND plan_id = #{planId}
        <if test="funType != null">
            AND fun_type = #{funType}
        </if>
        ORDER BY start_amount ASC
    </select>

    <!-- 查询方案下的奖励配置 -->
    <select id="queryRuleRewardByPlanId" resultType="com.minigod.zero.manage.vo.RuleRewardVO">
        SELECT
        <include refid="Base_Column_List"/>
        FROM operate_act_reward_plan
        WHERE is_deleted = 0
        AND status = 0
        AND plan_id = #{planId}
        <if test="funType != null">
            AND fun_type = #{funType}
        </if>
        ORDER BY start_amount ASC
    </select>

    <!-- 查询符合金额条件的奖励配置 -->
    <select id="getMatchedReward" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM operate_act_reward_plan
        WHERE is_deleted = 0
        AND status = 0
        AND plan_id = #{planId}
        AND fun_type = #{funType}
        AND start_amount &lt;= #{amount}
        AND (end_amount IS NULL OR end_amount >= #{amount})
        ORDER BY start_amount DESC
        LIMIT 1
    </select>

    <!-- 批量更新奖励方案状态 -->
    <update id="updateStatusByPlanId">
        UPDATE operate_act_reward_plan
        SET status      = #{status},
            update_time = NOW()
        WHERE plan_id = #{planId}
          AND is_deleted = 0
    </update>

    <!-- 删除奖励方案 -->
    <update id="deleteOperateActRewardPlan">
        UPDATE operate_act_reward_plan
        SET is_deleted = 1
        WHERE plan_id = #{planId}
          AND fun_type = #{funType}
    </update>
</mapper>
