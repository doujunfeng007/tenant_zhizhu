<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.minigod.zero.manage.mapper.PlatformCommonTemplateMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="informCommonTemplateResultMap" type="com.minigod.zero.platform.entity.PlatformCommonTemplateEntity">
        <result column="id" property="id"/>
        <result column="temp_code" property="tempCode"/>
        <result column="temp_code_hans" property="tempCodeHans"/>
        <result column="temp_code_hant" property="tempCodeHant"/>
        <result column="temp_code_en" property="tempCodeEn"/>
        <result column="temp_param" property="tempParam"/>
        <result column="title" property="title"/>
        <result column="title_hant" property="titleHant"/>
        <result column="title_en" property="titleEn"/>
        <result column="content" property="content"/>
        <result column="content_hant" property="contentHant"/>
        <result column="content_en" property="contentEn"/>
        <result column="apply_explain" property="applyExplain"/>
        <result column="msg_type" property="msgType"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="createUser" column="create_user"/>
        <result property="updateUser" column="update_user"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createDept" column="create_dept"/>
        <result property="channel" column="channel"/>
        <result column="create_user_name" property="createUserName"/>
        <result column="tenant_id" property="tenantId"/>

    </resultMap>

    <select id="queryTemplatePage" resultMap="informCommonTemplateResultMap" parameterType="java.lang.Object">
        select * from platform_common_template where is_deleted = 0 and tenant_id = #{tenantId}
        <if test="keyword != null and keyword != ''">
            and (
                    temp_code = #{keyword}
                    or temp_code_hans = #{keyword}
                    or temp_code_hant = #{keyword}
                    or temp_code_en = #{keyword}
                    or title like concat("%",#{keyword},"%")
                    or title_hant like concat("%",#{keyword},"%")
                    or title_en like concat("%",#{keyword},"%")
            )
        </if>
        <if test="msgType != null">
            and msg_type = #{msgType}
        </if>
        and  is_deleted = 0
        order by create_time desc
    </select>

    <select id="selectByTemplateCode" parameterType="java.lang.Object" resultMap="informCommonTemplateResultMap">
        select * from platform_common_template where is_deleted = 0 and tenant_id = #{tenantId} and temp_code  = #{templateCode}
    </select>

    <select id="getTemplateList" resultType="com.minigod.zero.manage.vo.MsgTemplateVO">
        select
        t2.id,
        t2.bus_id,
        t1.temp_name,
        t2.title,
        t2.title_hant,
        t2.title_en,
        t1.parent_id,
        t2.content,
        t2.content_hant,
        t2.content_en,
        t2.temp_code,
        t1.send_way,
        t2.msg_type
        from
        platform_template_type t1 left join platform_common_template t2 on t2.bus_id = t1.id
        where t2.status = 1 and t2.is_deleted = 0 and t1.parent_id not in (0)
        <if test="platformTemplateQueryVo.busType != null">
            and t1.bus_type = #{platformTemplateQueryVo.busType}
        </if>
        <if test="platformTemplateQueryVo.keyword != null and platformTemplateQueryVo.keyword != ''">
            and t1.keyword = #{platformTemplateQueryVo.keyword}
        </if>
        <if test="platformTemplateQueryVo.id != null">
            and t2.id = #{platformTemplateQueryVo.id}
        </if>
        <if test="platformTemplateQueryVo.tempName != null and platformTemplateQueryVo.tempName != ''">
            and t1.temp_name like concat('%',#{platformTemplateQueryVo.tempName},'%')
        </if>
        <if test="platformTemplateQueryVo.msgType != null">
            and t2.msg_type = #{platformTemplateQueryVo.msgType}
        </if>

        order by t2.temp_code desc
    </select>

    <select id="findTemplateByParentTypeId" resultType="com.minigod.zero.platform.entity.PlatformCommonTemplateEntity">
        select * from platform_common_template where bus_id in (select id from platform_template_type where parent_id = #{parentTypeId}) and status = 1 and is_deleted = 0
    </select>

    <select id="findTempMaxTempCode" resultType="java.lang.Integer">
        select max(temp_code) from platform_common_template where status = 1 and is_deleted = 0
    </select>

    <update id="update" parameterType="com.minigod.zero.platform.entity.PlatformCommonTemplateEntity">
        update platform_common_template
        <trim prefix="SET" suffixOverrides=",">
            <if test="content != null and content != ''">content =
                #{content},
            </if>
            <if test="contentHant != null and contentHant != ''">content_hant =
                #{contentHant},
            </if>
            <if test="contentEn != null and contentEn != ''">content_en =
                #{contentEn},
            </if>
            <if test="title != null and title != ''">title =
                #{title},
            </if>
            <if test="titleHant != null and titleHant != ''">title_hant =
                #{titleHant},
            </if>
            <if test="titleEn != null and titleEn != ''">title_en =
                #{titleEn},
            </if>
            <if test="applyExplain != null and applyExplain != ''">apply_explain =
                #{applyExplain},
            </if>
            <if test="updateUser != null">update_user =
                #{updateUser},
            </if>
            <if test="updateTime != null">update_time =
                #{updateTime},
            </if>
            <if test="status != null">`status` =
                #{status},
            </if>
            <if test="isDeleted != null">is_deleted =
                #{isDeleted},
            </if>
        </trim>
        where id = #{id}
    </update>

    <select id="selectTemplateByMsgType" parameterType="java.lang.String" resultMap="informCommonTemplateResultMap">
        select * from platform_common_template
        where is_deleted = 0 and tenant_id = #{tenantId} AND STATUS = 1 AND msg_type = #{msgType}
    </select>
</mapper>
