<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.minigod.zero.manage.mapper.HqPackageInfoMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.minigod.zero.manage.entity.HqPackageInfoEntity">
        <id column="id" property="id"/>
        <result column="package_id" property="packageId"/>
        <result column="package_name" property="packageName"/>
        <result column="package_code" property="packageCode"/>
        <result column="package_desc" property="packageDesc"/>
        <result column="pic_url" property="picUrl"/>
        <result column="old_price" property="oldPrice"/>
        <result column="new_price" property="newPrice"/>
        <result column="ccy_type" property="ccyType"/>
        <result column="total_num" property="totalNum"/>
        <result column="rest_num" property="restNum"/>
        <result column="expiry_date" property="expiryDate"/>
        <result column="discount" property="discount"/>
        <result column="market_id" property="marketId"/>
        <result column="effective_days" property="effectiveDays"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_user" property="createUser"/>
        <result column="update_user" property="updateUser"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="create_dept" property="createDept"/>
        <result column="status" property="status"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, package_id, package_name, package_code, package_desc, pic_url, old_price,
        new_price, ccy_type, total_num, rest_num, expiry_date, discount, market_id,
        effective_days, create_time, update_time, create_user, update_user,
        is_deleted, tenant_id, create_dept, status
    </sql>

    <!-- 分页查询 -->
    <select id="queryPage" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM hq_package_info
        WHERE is_deleted = 0
        <if test="packageName != null and packageName != ''">
            AND package_name LIKE CONCAT('%', #{packageName}, '%')
        </if>
        <if test="marketId != null">
            AND market_id = #{marketId}
        </if>
        ORDER BY create_time DESC
    </select>

    <!-- 根据套餐编码查询 -->
    <select id="getByPackageCode" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM hq_package_info
        WHERE is_deleted = 0
        AND package_code = #{packageCode}
        LIMIT 1
    </select>

    <!-- 查询有效的套餐列表 -->
    <select id="queryValidPackages" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM hq_package_info
        WHERE is_deleted = 0
        AND status = 0
        AND market_id = #{marketId}
        AND (expiry_date IS NULL OR expiry_date > NOW())
        AND rest_num > 0
        ORDER BY new_price ASC
    </select>

    <!-- 更新套餐库存 -->
    <update id="updateRestNum">
        UPDATE hq_package_info
        SET rest_num = rest_num + #{count}
        WHERE package_id = #{packageId}
          AND is_deleted = 0
          AND rest_num + #{count} >= 0
    </update>

</mapper>
